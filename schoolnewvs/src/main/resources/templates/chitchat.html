<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>学生聊天界面代码</title>
    <link rel="stylesheet" href="../static/css/amazeui.min.css"/>
    <link rel="stylesheet" href="../static/css/main.css"/>
</head>
<body>
<div class="box">
    <div class="wechat">
        <div class="sidestrip">
            <div class="am-dropdown" data-am-dropdown>
                <!--头像插件-->
                <div class="own_head am-dropdown-toggle"></div>
                <div class="am-dropdown-content">
                    <div class="own_head_top">
                        <div class="own_head_top_text">
                            <input hidden name="aid" th:value="${session.aid}">
                            <p class="own_name">彭于晏丶plus<img src="/static/images/icon/head.png" alt=""/></p>
                            <p class="own_numb">微信号：123456</p>
                        </div>
                        <img src="/static/images/own_head.jpg" alt="" class="aidimg"/>
                    </div>
                    <div class="own_head_bottom">
                        <p><span>地区</span><span class="diqu"></span></p>
                        <div class="own_head_bottom_img">
                            <a href=""><img src="/static/images/icon/head_1.png"/></a>
                            <a href=""><img src="/static/images/icon/head_2.png"/></a>
                        </div>
                    </div>
                </div>
            </div>
            <!--三图标-->
            <div class="sidestrip_icon">
                <a id="si_1" style="background: url(/static/images/icon/head_2_1.png) no-repeat;"></a>
                <a id="si_2"></a>
                <a id="si_3"></a>
            </div>

            <!--底部扩展键-->
            <div id="doc-dropdown-justify-js">
                <div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
                    <div class="sidestrip_bc am-dropdown-toggle"></div>
                    <ul class="am-dropdown-content" style="">
                        <li>
                            <a href="#"
                               data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
                            <div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
                                <div class="am-modal-dialog">
                                    <div class="am-modal-hd">Modal 标题
                                        <a href="javascript: void(0)" class="am-close am-close-spin"
                                           data-am-modal-close>&times;</a>
                                    </div>
                                    <div class="am-modal-bd">
                                        Modal 内容。本 Modal 无法通过遮罩层关闭。
                                    </div>
                                </div>
                            </div>
                        </li>

                        <li><a href="#">备份与恢复</a></li>
                        <li><a href="#">设置</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!--聊天列表-->
        <div class="middle on">
            <div class="wx_search">
                <input type="text" class="chahy" placeholder="搜索"/>
                <button class="addhao">+</button>
            </div>
            <div class="office_text">
                <ul class="user_list">

                </ul>
            </div>
        </div>

        <!--好友列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="friends_list">
                    <li class="xinHaoYou">
                        <p>新的朋友</p>
                    </li>
                </ul>
            </div>
        </div>

        <!--程序列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索收藏内容"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="icon_list">
                    <li class="icon_active">
                        <div class="icon"><img src="/static/images/icon/icon.png" alt=""/></div>
                        <span>全部收藏</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon1.png" alt=""/></div>
                        <span>链接</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon2.png" alt=""/></div>
                        <span>相册</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon3.png" alt=""/></div>
                        <span>笔记</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon4.png" alt=""/></div>
                        <span>文件</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon5.png" alt=""/></div>
                        <span>音乐</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon6.png" alt=""/></div>
                        <span>标签</span>
                    </li>
                </ul>
            </div>
        </div>

        <!--聊天窗口-->
        <div class="talk_window">
            <div class="windows_top">
                <div class="windows_top_box">
                    <span class="haoname"></span>
                    <input hidden class="haoid">
                    <ul class="window_icon">
                        <li><a href=""><img src="/static/images/icon/icon7.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon8.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon9.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon10.png"/></a></li>
                    </ul>
                    <div class="am-btn am-btn-success extend"  data-am-offcanvas="{target: '#doc-oc-demo3'}"></div>
                    <!-- 侧边栏内容 -->
                    <div id="doc-oc-demo3" class="am-offcanvas">
                        <div class="am-offcanvas-bar am-offcanvas-bar-flip">
                            <div class="am-offcanvas-content">
                                <p><a href="http://music.163.com/#/song?id=385554" target="_blank">网易音乐</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--聊天内容-->
            <div class="windows_body">
                <div class="office_text" style="height: 100%;">
                    <ul class="content" id="chatbox">

                    </ul>
                </div>
            </div>

            <div class="windows_input" id="talkbox">
                <div class="input_icon">
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                </div>
                <div class="input_box">
                    <input hidden class="haoid">
                    <textarea name="" rows="" cols="" id="input_box"></textarea>
                    <button id="send" class="liaotian">发送（S）</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../static/js/jquery.min.js"></script>
<script type="text/javascript" src="../static/js/amazeui.min.js"></script>
<script type="text/javascript" src="../static/js/zUI.js"></script>
<script type="text/javascript" src="../static/js/wechat.js"></script>
<script type="text/javascript" src="../static/layer/layer.js"></script>
<script type="text/javascript">
    $(function () {
        var aid = $("input[name=aid]").val();
        jiazai()
        cha();
        b();
        //搜索框查询好友
        $(".chahy").blur(function () {
            var chahy=$(".chahy").val();
            var jsonmo={
                "aid":aid,
                "nickname":chahy
            }
            $.post("/moHuCha",jsonmo,function (data) {
                $(".user_list li").remove();
                $.each(data.data,function (i,v) {
                    var beizhu = "";
                    if (typeof(v.beizhu) === "undefined") {
                        beizhu = "";
                    } else {
                        beizhu = v.beizhu;
                    }
                    var jsonhao = {
                        "aid": aid,
                        "haoid": v.haoid
                    }
                    $.ajax({
                        "url": "/lvSelectHaoXinXi",
                        "type": "POST",
                        "data": jsonhao,
                        "dataType": "json",
                        "async": false,
                        success: function (reslutHao) {
                            var xingQi;
                            var neiro = "";
                            var createdate;
                            if (typeof(reslutHao.data2.xiaoXis[0].createdate) === "undefined") {
                                xingQi = "未联系";
                            } else {
                                neiro = reslutHao.data2.xiaoXis[0].neirong;
                                createdate = reslutHao.data2.xiaoXis[0].createdate;
                                xingQi = date(createdate);
                            }
                            var $li;
                            if (dianClass == reslutHao.data2.haoid) {
                                if (typeof(reslutHao.data2.beizhu) == "undefined") {
                                    $li = $('<li class="user_active" ><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data.nickname + '</p> <p class="user_message">' + neiro + '</p></div> <div class="user_time">' + xingQi + '</div> </li>');
                                } else {
                                    $li = $('<li class="user_active"><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data2.beizhu + '</p> <p class="user_message">' + neiro + '</p> </div> <div class="user_time">' + xingQi + '</div> </li>');
                                }
                            } else {
                                if (typeof(reslutHao.data2.beizhu) == "undefined") {
                                    $li = $('<li class="user_li" ><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data.nickname + '</p> <p class="user_message">' + neiro + '</p></div> <div class="user_time">' + xingQi + '</div> </li>');
                                } else {
                                    $li = $('<li class="user_li"><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data2.beizhu + '</p> <p class="user_message">' + neiro + '</p> </div> <div class="user_time">' + xingQi + '</div> </li>');
                                }
                            }
                            $(".user_list").append($li);
                        }
                    })
                })
            },"json")
        })
        //模糊查询结束
        $(".addhao").click(function () {
            layer.open({
                type: 2,
                area: ['700px', '450px'],
                fixed: false, //不固定
                maxmin: true,
                content: '/jsp/addHao.jsp'
            });
        })
        //添加好友
        var jsonF={id:aid}
        $.post("/lvSelectFriends",jsonF,function (data1) {
            $.each(data1.data,function (i,v) {
                var backid=v.backid;
                $.post("lvSelectFriendsInfo",{id:v.aid},function (data) {
                    var $div=$(" <div class=\"friends_box\">\n" +
                        "                    <div class=\"user_head\"><img src=\"/static/touxiang/"+data.data.touxiang+"\"/></div>\n" +
                        "                    <div class=\"friends_text\">\n" +
                        "                    <span class=\"user_name\">"+data.data.nickname+"</span>\n" +
                        "                    <span hidden>"+data.data.accid+"</span><span style=\"margin-left:27px \"><button class='tong'>同意</button></span>\n" +
                        "                <span><button class='ju'>拒绝</button></span>\n" +
                        "                </div>\n" +
                        "                </div>");
                    $(".xinHaoYou").append($div)
                    $(".tong").click(function () {
                        var accid= $(this).parent().prev().text();
                        var th=$(this).parent().parent().parent();
                        $.post("/lvAddFriends",{accid:accid,aid:aid,backid:backid},function (result) {
                            if(result.success=="true"){
                                th.remove();
                                alert("已同意");
                            }
                        },"json")
                    })
                    $(".ju").click(function () {
                        var th=$(this).parent().parent().parent();
                        $.post("/lvDelFriends",{backid:backid},function (result) {
                            if(result.success=="true"){
                                th.remove();
                                alert("已拒绝");
                            }
                        },"json")
                    })
                },"json")
            })
        },"json")

    })//jquery工厂函数
    var dianClass;
    function jiazai() {
        var aid = $("input[name=aid]").val();
        $.post("/lvSelectAid",{aid:aid},function (data) {
            console.log(data)
            $(".own_head").css("background","url(/static/touxiang/"+data.userInfo.touxiang+")")
            $(".own_head").css("background-size","34px")
            $(".own_name").text(data.userInfo.nickname)
            $(".diqu").text(data.userInfo.address)
            $(".own_numb").text("微信号："+data.account.accountname)

            $(".aidimg").prop("src","/static/touxiang/"+data.userInfo.touxiang+"");
        },"json")
    }
    function cha() {
        var aid = $("input[name=aid]").val();
        var json = {
            "aid": aid
        }
        //根据登陆的账号id获取他的好友
        var $li;
        $.post("/lvSelectHao", json, function (reslut) {
            $(".user_list li").remove();
            //判断是否有好友
            if (reslut.status == "true") {
                $.each(reslut.data, function (i, v) {
                    var beizhu = "";
                    if (typeof(v.beizhu) === "undefined") {
                        beizhu = "";
                    } else {
                        beizhu = v.beizhu;
                    }
                    var jsonhao = {
                        "aid": aid,
                        "haoid": v.haoid
                    }
                    $.ajax({
                        "url": "/lvSelectHaoXinXi",
                        "type": "POST",
                        "data": jsonhao,
                        "dataType": "json",
                        "async": false,
                        success: function (reslutHao) {
                            var xingQi;
                            var neiro = "";
                            var createdate;
                            if (reslutHao.data2.xiaoXis[0].createdate == null) {
                                xingQi = "未联系";
                            } else {
                                neiro = reslutHao.data2.xiaoXis[0].neirong;
                                createdate = reslutHao.data2.xiaoXis[0].createdate;
                                xingQi = date(createdate);
                            }
                            var $li;
                            if (dianClass == reslutHao.data2.haoid) {
                                if (reslutHao.data2.beizhu == null) {
                                    $li = $('<li class="user_active" ><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data.nickname + '</p> <p class="user_message">' + neiro + '</p></div> <div class="user_time">' + xingQi + '</div> </li>');
                                } else {
                                    $li = $('<li class="user_active"><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data2.beizhu + '</p> <p class="user_message">' + neiro + '</p> </div> <div class="user_time">' + xingQi + '</div> </li>');
                                }
                            } else {
                                if (reslutHao.data2.beizhu == null) {
                                    $li = $('<li class="user_li" ><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data.nickname + '</p> <p class="user_message">' + neiro + '</p></div> <div class="user_time">' + xingQi + '</div> </li>');
                                } else {

                                    $li = $('<li class="user_li"><div class="user_head"><input hidden value=' + reslutHao.data2.haoid + '><img src="/static/touxiang/'+reslutHao.data.touxiang+'"/></div><div class="user_text"> <p class="user_name">' + reslutHao.data2.beizhu + '</p> <p class="user_message">' + neiro + '</p> </div> <div class="user_time">' + xingQi + '</div> </li>');
                                }
                            }
                            $(".user_list").append($li);
                        }
                    })
                })
                $(".user_li").click(function () {
                    $("#chatbox li").remove();
                    $(this).attr("class", "user_active");
                    $(this).siblings().attr("class", "user_li")
                    var name = $(this).children(".user_text").children(".user_name").text();
                    var haoid = $(this).children(".user_head").children("input").val();
                    var haoimg = $(this).children(".user_head").children("img").attr("src");
                    dianClass = haoid;
                    liaoTian(haoid, haoimg, name)
                })
                //没有好友
            } else {
            }//判断是否有好友else
        }, "json")//根据登陆的账号id获取他的好友post
    }
    //局部刷新
    function xun() {
        time = setInterval(function getoList() {
            cha();
        }, 3000);
    }

    function liaoTian(haoid, haoimg, name) {

        var aid = $("input[name=aid]").val();
        var jsonxiao = {
            "aid": aid,
            "haoid": haoid
        }
        var aidimg = $(".aidimg").attr("src");
        var aname = $(".own_name").text();
        $(".haoname").text(name);
        $(".haoid").text(haoid);
        $.post("lvSelectHaoXiaoXi", jsonxiao, function (result1) {
            $(".content li").remove();
            $.each(result1.data, function (i, v) {
                $.each(v.xiaoXis, function (i1, v1) {

                    if (typeof(v1.createdate) == "undefined") {
                    } else {
                        var $lis;
                        if (v1.zhu == aid) {

                            $lis = $('<li class="me"><img src=' + aidimg + ' title=' + aname + '><span>' + v1.neirong + '</span></li>');
                        }
                        if (v1.zhu == haoid) {

                            $lis = $('<li class="other"><img class="haoimg" src=' + haoimg + ' title=' + name + '><span>' + v1.neirong + '</span></li>');
                        }
                        var $da = $('<li style="margin: 0px 200px;"><span>' + v1.createdate.substring(0,19) + '</span></li>')
                        $("#chatbox").append($da);
                        $("#chatbox").append($lis);
                    }

                })
            })
        }, "json")
    }

    function date(timei) {
        var weekDay = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
        var myDate = new Date(Date.parse(timei));
        var myDay=new Date().getDay();
        var times=timei.substring(0,10);
        var bo=false;
        for (var i=myDay-1;i>=0;i--){
            var day1 = new Date();
            day1.setTime(day1.getTime()-24*60*60*1000*i);
            var s1 = day1.getFullYear()+"-" + (day1.getMonth()+1)+"-" + day1.getDate();
            if (s1==times){
                bo=true;
                break;
            }
        }
        var xingQi;
        if (bo==false){
            xingQi=timei.substring(0,10);
        }else if(new Date().getDate()==new Date(timei).getDate()){
            var hours=parseInt(new Date(timei).getHours())+1;
            if (hours>0&&hours<=6){
                xingQi="凌晨"+timei.substring(11,16);;
            }else if(hours>6&&hours<=10){
                xingQi="早上"+timei.substring(11,16);;
            }else if(hours>10&&hours<=14){
                xingQi="中午"+timei.substring(11,16);;
            }else if(hours>14&&hours<=19){
                xingQi="下午"+timei.substring(11,16);;
            }else if(hours>19&&hours<=23){
                xingQi="晚上"+timei.substring(11,16);;
            }
        }else if(parseInt(new Date().getDate())-1==new Date(timei).getDate()){
            xingQi="昨天";
        } else if(bo){

            xingQi=weekDay[myDate.getDay()];
        }
        return xingQi;
    }

    function b() {
        var text = document.getElementById('input_box');
        var chat = document.getElementById('chatbox');
        var btn = document.getElementById('send');
        var talk = document.getElementById('talkbox');
        btn.onclick = function () {
            if (typeof ($(".user_active").html()) == "undefined") {
                layer.msg('选择好友', function () {
                });
                return;
            }
            if (text.value == '') {
                layer.msg('不能发送空消息', function () {
                });
            } else {
                var aidimg = $(".aidimg").attr('src');
                var haoname = $(".haoname").text();
                var haoid = $(".haoid").text().substring(1)
                var aid = $("input[name=aid]").val();
                var haoimg = $(".haoimg").attr("src");
                console.log(haoid);
                var json = {
                    "aid": aid,
                    "haoid": haoid,
                    "neirong": text.value
                }
                $.post("/addXiaoXi", json, function (data) {
                    if (data.success == "true") {
                        liaoTian(haoid, haoimg, haoname)
                    } else {
                        layer.msg('发送失败', function () {
                        });
                    }
                }, "json")
                text.value = '';
                chat.scrollTop = chat.scrollHeight;
                talk.style.background = "#fff";
                text.style.background = "#fff";
            }
        }
    }


    //三图标
    window.onload = function () {
        //导航栏切换
        function a() {
            var si1 = document.getElementById('si_1');
            var si2 = document.getElementById('si_2');
            var si3 = document.getElementById('si_3');
            si1.onclick = function () {
                si1.style.background = "url(../static/images/icon/head_2_1.png) no-repeat"
                si2.style.background = "";
                si3.style.background = "";
            };
            si2.onclick = function () {
                si2.style.background = "url(../static/images/icon/head_3_1.png) no-repeat"
                si1.style.background = "";
                si3.style.background = "";
            };
            si3.onclick = function () {
                si3.style.background = "url(../static/images/icon/head_4_1.png) no-repeat"
                si1.style.background = "";
                si2.style.background = "";
            };
        };
        //发送消息
        a();
    };
</script>
</body>
</html>